<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="generator" content="Aspose.Words for .NET 24.7.0" /><title></title><style type="text/css">body { font-family:Calibri; font-size:11pt }h2, h3, p { margin:0pt 0pt 8pt }li { margin-top:0pt; margin-bottom:8pt }h2 { margin-top:12pt; margin-bottom:3pt; page-break-after:avoid; font-family:Arial; font-size:14pt; font-weight:bold; font-style:italic }h3 { margin-top:12pt; margin-bottom:3pt; page-break-after:avoid; font-family:Arial; font-size:13pt; font-weight:bold }.FencedCode { margin-bottom:8pt; font-family:Consolas; font-size:10pt; background-color:#e2e2e2 }.FencedCodehtml { margin-bottom:8pt; font-family:Consolas; font-size:10pt; background-color:#e2e2e2; -aw-style-name:'FencedCode.html=' }.FencedCodepython { margin-bottom:8pt; font-family:Consolas; font-size:10pt; background-color:#e2e2e2; -aw-style-name:'FencedCode.python=' }span.InlineCode3 { font-family:Consolas; font-size:10pt; color:#c7254e; background-color:#f9f2f4; -aw-style-name:'InlineCode.3' }</style></head><body><div><h2><span style="font-family:Calibri; font-weight:normal; font-style:normal">說明</span></h2><p><span>本文中將介紹CloudFront各種功能，並透過一些小Lab驗證。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>Last update :2024/07/07</span></p><h2><span style="font-weight:normal; font-style:normal">General</span></h2><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Price class</span><span> - 使用不同CloudFront節點會有不同費用</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Alternate domain name (CNAME) - optional</span><span> - 如果CloudFront有串接CNAME時的設定</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Custom SSL certificate - optional</span><span> - 當有使用ACM時會需要在這設定</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Supported HTTP versions</span><span> - 設定HTTP</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Default root object - optional</span><span> - 設定default訪問的路徑。</span><br /><span>以S3為例在設定時僅能設定對應的檔案，default的路徑是在Origin的Origin path設定。因此當需要在訪問cloudfront的default路徑為s3的/path2/index2.html，就需要將origin path設定為path2，並在General的Default root object設定</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Standard logging</span><span> - 輸出log至S3 Bucket中</span><br /><span>當需要檢視log時可以透過Athena檢視[3]。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Description - optional</span><span> - CloudFront在頁面中顯示的名稱，以分辨不同CloudFront</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Continuous deployment</span><span> - CloudFront可以測試在不同CloudFront 設定下對服務的影響，因此當檢視CloudFront時會有staging以及Production。</span><br /><span>當在測試時，可以透過weight或者是不同header的方式測試Staging以及Production。header的開頭需要為aws-cf-cd-</span><br /><span>當測試完確認後，可以直接選擇Promote切換Stag以及Prod，當Promote完成後CloudFront的distribute不會改變，而是將Stag的設定套用至Prod</span></p><h2><span style="font-weight:normal; font-style:normal">Security</span></h2><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">WAF</span><span> - 是否啟用WAF</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">CloudFront geographic restrictions</span><span> - CloudFront可以根據國家直接設定白名單以及block名單</span></p><h2><span style="font-weight:normal; font-style:normal">Origin</span></h2><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Origin domain</span><span> - 可以訪問哪些domain</span><br /><span>該domain default設定是S3、Load Balancer、API Gateway、MediaStore container、Mediapackage container、Mediapackage V2 endpoint。</span><br /><span>除了上述之外也可以使用EC2或者自定義的domain</span><br /><span>如果S3已經設定為靜態網站，要使用對應的endpoint</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Origin path - optional</span><span> - 訪問時訪問該origin的哪個分頁</span><br /><span>以S3為例 - 如果Origin path設定為/demo2時，當使用者訪問cloudFront/index.html時，會訪問s3的/demo2/index.html</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Name</span><span> - 名稱</span><br /><span>單純區別的名稱</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Add custom header</span><br /><span>該處的header設定主要是由CloudFront傳至orgin的設定。</span><br /><span>以使用情境來說，當CloudFront傳至EC2時，EC2可以透過header的方式只允許帶有header的請求進行訪問。</span><br /><span>以下是簡單的FLASK測試範例，當使用者未帶header訪問時會回傳401。</span></p><p class="FencedCodepython"><span>from flask import Flask, request</span><br /><br /><span>app = Flask(__name__)</span><br /><br /><span>@app.route('/')</span><br /><span>def hello():</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>if request.headers.get('test123') == 'values456':</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>return 'Hello World'</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>else:</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>return 'Unauthorized', 401</span><br /><br /><span>if __name__ == '__main__':</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>app.run(host='0.0.0.0', port=80)</span></p><p><span style="font-weight:bold">Enable Origin Shield</span><span> - Origin Shield主要是提供靜態資訊快取的設定</span></p><p><span style="font-weight:bold">Additional settings</span><span> - Connection 的設定</span></p><p><span style="font-weight:bold">Origin groups</span><span> - 當CloudFront提供多個origin時，當A Origin發生指定的錯誤時(4xx 5xx)會依順序response B Origin。</span></p><h2><span style="font-weight:normal; font-style:normal">Behaviros</span></h2><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Path pattern</span><span> - 主要是針對請求的時候的反應</span><br /><span>如：CloudFront使用OAC串接S3靜態圖片時，可以設定.png皆為使用快取</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Origin and origin groups</span><span> - 與先前的Origin做合併</span></p><h3><span style="font-weight:normal">Viewer</span></h3><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Viewer protocol policy</span><span> - 當http或https請求至CloudFront時，CloudFront可以採取的措施。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Allowed HTTP methods</span><span> - 可允許的http請求，僅能透過選項選取。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span style="font-weight:bold">Restrict viewer access</span><span>-如果需要在訪問時使用進一步限制</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="-aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>如果是使用S3 OAC至少要選擇Trusted key groups (recommended)。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="-aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>如果是Ec2會需要提供public key，Public key 可以透過openssl建立當建立完憑證後需要將public key 上傳至CloudFront的key manager中，並且建立Key group。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="-aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>使用者訪問時會需要提供以下內容</span><span class="InlineCode3">https://{distrubute}cloudfront.net/path?Expires={expire time(Unix Timestamp)}&amp;Signature={下方說明}&amp;Key-Pair-Id={Key management中Public keys的ID}</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'; -aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>Signature 設定[4] -</span><br /><span>(1)建立canned-policy，格式如下</span></p><div style="margin-left:18pt; margin-bottom:8pt; background-color:#e2e2e2"><p class="FencedCode" style="margin-left:18pt; margin-bottom:0pt; text-indent:-18pt; background-color:transparent; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:12pt"><span style="-aw-import:ignore"><span><span style="-aw-import:spaces">&#xa0;</span></span><span style="width:12pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>{</span><br /><span>"Statement":[</span><br /><span>{ </span><br /><span style="-aw-import:spaces">&#xa0; </span><span>"Resource":"https://dqofozeouve3j.cloudfront.net/0m-HR.mp4",</span><br /><span style="-aw-import:spaces">&#xa0; </span><span>"Condition":{</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>"DateLessThan":{ "AWS:EpochTime":1704038400 }</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>}</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>}</span><br /><span style="-aw-import:spaces">&#xa0; </span><span>]</span><br /><span>}</span></p></div><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'; -aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>(2)透過ssl 計算 Signature</span></p><div style="margin-left:18pt; margin-bottom:8pt; background-color:#e2e2e2"><p class="FencedCode" style="margin-left:18pt; margin-bottom:0pt; text-indent:-18pt; background-color:transparent; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:12pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'; -aw-import:spaces">&#xa0;</span></span><span style="width:12pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>cat canned-policy | tr -d " \t\n\r" | openssl sha1 -sign private_key.pem | openssl base64 | tr -- '+=/' '-_~' | tr -d "\n" | perl -ne 'print "$_\n"'</span></p></div><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'; -aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>計算後會得到Signature值</span></p><div style="margin-left:18pt; margin-bottom:8pt; background-color:#e2e2e2"><p class="FencedCode" style="margin-left:18pt; margin-bottom:0pt; text-indent:-18pt; background-color:transparent; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:12pt"><span style="-aw-import:ignore"><span><span style="-aw-import:spaces">&#xa0;</span></span><span style="width:12pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>AtVt~jTeY-~oPMtRpeLw1PdCtF7xZh-sHwcoY0VmgNMdLtN1l3YeY4mvw0I85NBIfEgoWNjn2B4BbUGB5mNPTyhlCXWaWxPsBd2YHkIcjOHII-WnlvQTqi9QpvVvPAKpUgrOWcAkIhaLRYHxRq1NMuzVzDfjbP1ec7fcfdI5sZnh2dYQsq1kNpqONMwCaUhOQdBiATwbRtjWmvQbSo7e7jQ8ZDbHeknvUVlkIZBQCZnUZk47qLpYsrUOSzadXCRAi81xaeLCiKJuqvLVQ~wB0hL8Z5q-wWqMtqRHnsLV1hKwqtoA0cKLfHYIMBsRMJixhgKOK7uYeJY3nMwmu1RBKQ__</span></p></div><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:' '; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'; -aw-import:spaces">&#xa0;</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>若使用Trusted signer會需要透過root做設定，這邊不建議使用。</span></p><h3><span style="font-weight:normal">Cache key and origin requests</span></h3><p><span>Cache的使用主要是透過CloudFront就近的節點讓使用者可以更快速訪問</span></p><p><span style="font-weight:bold">cache設定</span><span> -</span><br /><span>(1)CloudFront中Legacy cache settings直接設定cache時間</span><br /><span>(2)若是串接S3，可以點選S3的Object設定Metadata，設定Type選擇 System defined； Key 選擇 Cache-Control或Expires</span><br /><span>(3)header</span><br /><span>(4)query string: 當請求帶有string時</span><span class="InlineCode3">https://d111111abcdef8.cloudfront.net/images/image.jpg?color=red&amp;size=large</span><span>當中就可以設定當出現color=red時使用快取。順序前後以及字串大小寫會影響快取(先color再size或者先size再color)</span><br /><span>(5)cookie</span></p><p><span style="font-weight:bold">Origin request settings</span><span> - 設定Request進來之後會將哪些導致Origin中，如果是選擇All，那麼就不會有快取，所有請求都會導向Origin。</span></p><h3><span style="font-weight:normal">Response headers policy - optional</span></h3><p><span>該處主要是對於CORS的設定[5][6][7][8]</span></p><p><span>以下將進行簡單的測試，主要是建立一個CORS resource server 以及consume server，並在consume server對resource請求，當沒有設定CORS的情況下會回傳</span><span class="InlineCode3">Error: Could not connect to Server1. [Errno 111] Connection refused</span><span>，以下將是測試內容。</span></p><ol type="1" style="margin:0pt; padding-left:0pt"><li style="margin-left:31.35pt; padding-left:4.65pt"><span>CORS resource server</span></li></ol><p class="FencedCode"><span>#!/bin/bash</span><br /><span>python3 -m venv tutorial-env</span><br /><span>source tutorial-env/bin/activate</span><br /><span>pip3 install FLASK</span><br /><span>pip3 install flask_cors</span><br /><span>pip3 install httpx</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>app.py</span></p><p class="FencedCode"><span>from flask import Flask</span><br /><span>from flask_cors import CORS</span><br /><br /><span>app = Flask(__name__)</span><br /><span>CORS(app)</span><br /><span>CORS(app, resources={r"/.*": {"origins": ["http://1.2.3.4"]}})</span><br /><br /><span>@app.route('/')</span><br /><span>def hello_world():</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>return 'Hello, World! From CROS Origin'</span><br /><br /><span>if __name__ == '__main__':</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>app.run(host='0.0.0.0', port=5000)</span></p><p><span>2.consume server</span></p><p class="FencedCode"><span>#!/bin/bash</span><br /><span>python3 -m venv tutorial-env</span><br /><span>source tutorial-env/bin/activate</span><br /><span>pip3 install FLASK</span><br /><span>pip3 install httpx</span></p><p><span>app2.py</span></p><p class="FencedCode"><span>from flask import Flask</span><br /><span>import httpx</span><br /><br /><span>app = Flask(__name__)</span><br /><br /><span>SERVER1_URL = "http://1.2.3.4:5000/"</span><span style="-aw-import:spaces">&#xa0; </span><span># 替換為 Server1 的實際 IP 和端口</span><br /><br /><span>@app.route('/')def proxy_to_server1():</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>try:</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>with httpx.Client() as client:</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>response = client.get(SERVER1_URL)</span><br /><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>if response.status_code == 200:</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>return response.text</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>else:</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>return f"Error: Received status code {response.status_code} from Server1", 500</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>except httpx.RequestError as e:</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span>return f"Error: Could not connect to Server1. {str(e)}", 500</span><br /><br /><span>if __name__ == '__main__':</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>app.run(host='0.0.0.0', port=5000)</span></p><h3><span style="font-weight:normal">Additional settings</span></h3><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'*'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">*</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>Smooth streaming</span><br /><span>如果使用Microsoft Smooth Streaming時並且沒有使用IIS server就可以選擇此功能</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'*'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">*</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>Field-level encryption</span><br /><span>進行更近一步的資料加密</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'*'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">*</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>Enable real-time logs</span><br /><span>real-time log</span></p><h3><span style="font-weight:normal">Function associations</span></h3><p><span>除了上述的方法外，如果需要按照自己的需求設定request以及response的內容，那麼可以透過function做設定。設定時可以選擇CloudFront Functions或者是Lambda@Edge。</span><br /><span>CloudFront function主要是透過JavaScript快速的以及簡易的回覆，如果需要較為複雜的回覆可以透過Node.js 或者 Python的Lambda@Edge。</span></p><ol type="1" style="margin:0pt; padding-left:0pt"><li style="margin-left:31.35pt; padding-left:4.65pt"><span>使用情境</span></li></ol><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>CloudFront function</span></p><p><span>(1) Cache key normalization – 將 HTTP request attributes 修改並建立optimal cache key以增加快取命中率</span></p><p><span>(2) Header manipulation – 對request 或者 response 的header進行修改</span></p><p><span>(3) URL redirects or rewrites – 根據request提供的不同訊息進行redirect</span></p><p><span>(4) Request authorization – 確保只有授權的用戶可以訪問內容。</span></p><p style="margin-left:36pt; text-indent:-18pt; -aw-import:list-item; -aw-list-level-number:0; -aw-list-number-format:'-'; -aw-list-number-styles:'bullet'; -aw-list-padding-sml:11.4pt"><span style="-aw-import:ignore"><span><span style="font-family:'Courier New'">-</span></span><span style="width:11.4pt; font:7pt 'Times New Roman'; display:inline-block; -aw-import:spaces">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span></span><span>Lambda@Edge</span><br /><span>(1) 需要幾毫秒或更長時間才能完成的函數(函數持續時間可至5秒)</span></p><p><span>(2) 需要可調式 CPU 或記憶體的功能</span></p><p><span>(3) 依賴第三方程式庫的函式 (包括 AWS SDK，以便與其他程式庫整合 AWS 服務)</span></p><p><span>(4) 需要網路存取才能使用外部服務進行處理的功能</span></p><p><span>(5) 需要文件系統訪問或訪問 HTTP 請求主體的功能</span></p><h2><span style="font-weight:normal; font-style:normal">Error pages -</span></h2><p><span>當發生錯誤時可以設定在不同HTTP error時對應的的回應error page以及可以根據需求設定error code。</span></p><h2><span style="font-weight:normal; font-style:normal">Invalidations</span></h2><p><span>當請求成功後會將快取存在節點中，如果需要手動更新節點就可以使用此功能，透過指定位置將該位置的快取清除。</span></p><h2><span style="font-family:Calibri; font-weight:normal; font-style:normal">額外資料</span></h2><h3><span style="font-weight:normal">.NET</span><span style="font-family:Calibri; font-weight:normal">環境建置</span></h3><p><span>EC2 linux2</span></p><p class="FencedCode"><span>sudo rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm</span><br /><span>sudo yum install dotnet-sdk-6.0 -y</span><br /><span>sudo yum install libicu -y</span><br /><span>export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1</span><br /><br /><span>dotnet new webapp -n MyWebApp</span><br /><span>cd MyWebApp</span><br /><span>vim Pages/Index.cshtml</span></p><p><span>將內容修改為</span></p><p class="FencedCodehtml"><span>@page</span><br /><span>@model IndexModel</span><br /><span>@{</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>ViewData["Title"] = "Home page";</span><br /><span>}</span><br /><br /><span>&lt;div class="text-center"&gt;</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>&lt;h1 class="display-4"&gt;Welcome to my AWS EC2 .NET Web App&lt;/h1&gt;</span><br /><span style="-aw-import:spaces">&#xa0;&#xa0;&#xa0; </span><span>&lt;p&gt;This is a simple ASP.NET Core web application running on AWS EC2 Linux 2.&lt;/p&gt;</span><br /><span>&lt;/div&gt;</span></p><p><span>執行.NET</span></p><p class="FencedCode"><span>dotnet run</span></p><p><span>修改接聽的port</span></p><p class="FencedCode"><span>vim Properties/launchSettings.json</span></p><p><span>修改以下內容</span></p><p class="FencedCode"><span>"applicationUrl": "http://0.0.0.0:80"</span></p><p><span>執行程式</span></p><p class="FencedCode"><span>dotnet run</span></p><h3><span style="font-weight:normal">HTTP request</span></h3><h2><span style="font-family:Calibri; font-weight:normal; font-style:normal">參考資料：</span></h2><p><span>[1]AWS CloudFront說明</span><br /><span>https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html</span></p><p><span>[2]AWS Best Practices for DDoS Resiliency</span><br /><span>https://docs.aws.amazon.com/whitepapers/latest/aws-best-practices-ddos-resiliency/aws-best-practices-ddos-resiliency.html</span></p><p><span>[3]Athena for CloudFront log</span><br /><span>https://docs.aws.amazon.com/athena/latest/ug/cloudfront-logs.html</span></p><p><span>[4]SignedURL 設定</span><br /><span>https://ithelp.ithome.com.tw/articles/10328887?sc=rss.iron</span></p><p><span>[5]CORS</span><br /><span>https://aws.amazon.com/tw/what-is/cross-origin-resource-sharing/</span></p><p><span>[6] CORS-2</span><br /><span>https://developer.mozilla.org/zh-TW/docs/Web/HTTP/CORS</span></p><p><span>[7] CORS-3</span><br /><span>https://www.shubo.io/what-is-cors/#google_vignette</span></p><p><span>[8] CORS-4</span><br /><span>https://www.maxlist.xyz/2020/05/08/flask-cors/</span></p></div></body></html>